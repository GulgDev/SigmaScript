(()=>{"use strict";var __webpack_modules__={842:(t,e,n)=>{n.d(e,{h:()=>i});var s=n(879),r=n(56);class i extends s.j{constructor(){super(...arguments),this.registry=new r.O("array"),this.functions={array:(...t)=>this.array(t),array_add:(t,e)=>this.add(t,e),array_remove:(t,e)=>this.remove(t,e),array_at:(t,e)=>this.at(t,e),array_set:(t,e,n)=>this.set(t,e,n),array_length:t=>this.length(t),array_find:(t,e)=>this.find(t,e)}}array(t){return this.registry.add(t)}add(t,e){return this.registry.get(t)?.push(e),"unknown"}remove(t,e){return this.registry.get(t)?.splice(Number.parseInt(e),1),"unknown"}at(t,e){return this.registry.get(t)?.at(Number.parseInt(e))??"unknown"}set(t,e,n){const s=this.registry.get(t),r=Number.parseInt(e);return s&&!Number.isNaN(r)&&r>=-s.length&&r<s.length&&(s[r<0?s.length+r:r]=n),"unknown"}length(t){const e=this.registry.get(t);return null==e?"unknown":`${e.length}`}find(t,e){const n=this.registry.get(t)?.indexOf(e);return null==n||-1===n?"unknown":`${n}`}getArray(t){return this.registry.get(t)}}},855:(t,e,n)=>{n.d(e,{a:()=>i});var s=n(879),r=n(56);class i extends s.j{constructor(){super(...arguments),this.registry=new r.O("fn"),this.functions={call:(t,...e)=>this.call(t,e)}}addFn(t){return this.registry.add(t)}getFn(t){return this.registry.get(t)}call(t,e){return this.registry.get(t)?.(...e)??"unknown"}}},879:(t,e,n)=>{n.d(e,{j:()=>r,y:()=>s});class s{constructor(t,e){this.result=null,this.runtime=t,this.func=e}use(t){this.runtime.copyScope(this.result??(this.result=this.func(this.runtime)),t)}}class r{constructor(t){this.variables={},this.functions={},this.runtime=t}use(t){Object.assign(t.variables,this.variables),Object.assign(t.functions,this.functions)}}},416:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{V:()=>JSLib});var ___WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(879),_registry__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(56),_array__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(842),_fn__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(855),_ref__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(642),_struct__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(126);const ssSymbol=Symbol("ss");class JSLib extends ___WEBPACK_IMPORTED_MODULE_4__.j{constructor(){super(...arguments),this.registry=new _registry__WEBPACK_IMPORTED_MODULE_5__.O("js"),this.functions={js:t=>this.js(t),js_get:(t,e)=>this.get(t,e),js_set:(t,e,n)=>this.set(t,e,n),js_new:(t,...e)=>this.new(t,e),js_object:()=>this.toSS({}),js_array:()=>this.toSS([]),js_call:(t,...e)=>this.call(t,e),js_call_method:(t,e,...n)=>this.callMethod(t,e,n)}}getObject(t){return this.registry.get(t)}toJSObject(t){if(t.startsWith("#js:"))return this.getObject(t);if(t.startsWith("#fn")){const e=this.runtime.getLib(_fn__WEBPACK_IMPORTED_MODULE_1__.a).getFn(t);if(!e)return;return(...t)=>this.toJS(e(...t.map((t=>this.toSS(t)))))}if(t.startsWith("#struct:")){const e=this.runtime.getLib(_struct__WEBPACK_IMPORTED_MODULE_3__.B).getStruct(t);if(!e)return;const n={};for(const t in e)n[t]=this.toJS(e[t]);return n}if(t.startsWith("#array:")){const e=this.runtime.getLib(_array__WEBPACK_IMPORTED_MODULE_0__.h).getArray(t);if(!e)return;return e.map((t=>this.toJS(t)))}return t}toJS(t){if(t.startsWith("#ref:"))return this.toJS(this.runtime.getLib(_ref__WEBPACK_IMPORTED_MODULE_2__.t).get(t));if("unknown"===t)return;if("false"===t)return!1;if("true"===t)return!0;if(/^-?[0-9]+(\.[0-9]+)?$/.test(t))return Number.parseFloat(t);const e=this.toJSObject(t);return e instanceof Object&&!e[ssSymbol]&&Object.defineProperty(e,ssSymbol,{value:t,enumerable:!1}),e}toSS(t){const e=t[ssSymbol];return void 0!==e?e:null==t||Number.isNaN(t)?"unknown":"string"==typeof t||t instanceof String||"boolean"==typeof t||t instanceof Boolean||"number"==typeof t||t instanceof Number?`${t}`:this.registry.add(t)}js(code){return this.toSS(eval(code))}get(t,e){const n=this.toJS(t)?.[e];return null==n?"unknown":this.toSS(n)}set(t,e,n){const s=this.toJS(t);return null!=s&&(s[e]=this.toJS(n)),"unknown"}new(t,e){const n=this.toJS(t);if(null==n)return"unknown";const s=new n(...e.map((t=>this.toJS(t))));return null==s?"unknown":this.toSS(s)}call(t,e){const n=this.toJS(t)?.(...e.map((t=>this.toJS(t))));return null==n?"unknown":this.toSS(n)}callMethod(t,e,n){const s=this.toJS(t)?.[e]?.(...n.map((t=>this.toJS(t))));return null==s?"unknown":this.toSS(s)}}},642:(t,e,n)=>{n.d(e,{t:()=>i});var s=n(879),r=n(56);class i extends s.j{constructor(){super(...arguments),this.registry=new r.O("ref"),this.functions={ref:t=>this.ref(t),ref_set:(t,e)=>this.set(t,e),ref_get:t=>this.get(t)}}ref(t){return this.registry.add(t)}set(t,e){return this.registry.set(t,e),"unknown"}get(t){return this.registry.get(t)??"unknown"}}},126:(t,e,n)=>{n.d(e,{B:()=>i});var s=n(879),r=n(56);class i extends s.j{constructor(){super(...arguments),this.registry=new r.O("struct"),this.functions={struct:()=>this.struct(),struct_set:(t,e,n)=>this.set(t,e,n),struct_get:(t,e)=>this.get(t,e)}}struct(){return this.registry.add({})}set(t,e,n){const s=this.registry.get(t);return s&&(s[e]=n),"unknown"}get(t,e){return this.registry.get(t)?.[e]??"unknown"}getStruct(t){return this.registry.get(t)}}},56:(t,e,n)=>{n.d(e,{O:()=>s});class s{constructor(t){this.elements={},this.id=-1,this.name=t}add(t){const e=`#${this.name}:${++this.id}`;return this.elements[e]=t,e}set(t,e){t in this.elements&&(this.elements[t]=e)}get(t){return this.elements[t]}}}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var n=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(t,e)=>{for(var n in e)__webpack_require__.o(e,n)&&!__webpack_require__.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var __webpack_exports__={};(()=>{class t{constructor(t,e,n){this.state="pending",this.callback=n,this.promise=e,this.promise.then((t=>{this.result=t,this.state="ready",this.update()})),this.index=t.length,this.queue=t,t.push(this)}update(){"ready"!==this.state||0!==this.index&&"done"!==this.queue[this.index-1].state||(this.state="done",this.callback(this.result),this.queue[this.index+1]?.update())}}var e=__webpack_require__(879),n=__webpack_require__(56),s=__webpack_require__(855);class r extends e.j{constructor(){super(...arguments),this.registry=new n.O("dom"),this.variables={dom_head:this.registry.add(document.head),dom_body:this.registry.add(document.body)},this.functions={dom_title:t=>this.title(t),dom_create:t=>this.create(t),dom_find:t=>this.find(t),dom_append:(t,e)=>this.append(t,e),dom_remove:t=>this.remove(t),dom_add_class:(t,e)=>this.addClass(t,e),dom_remove_class:(t,e)=>this.removeClass(t,e),dom_toggle_class:(t,e)=>this.toggleClass(t,e),dom_set_text:(t,e)=>this.setText(t,e),dom_set_html:(t,e)=>this.setHtml(t,e),dom_set_attr:(t,e,n)=>this.setAttr(t,e,n),dom_get_attr:(t,e)=>this.getAttr(t,e),dom_css:(t,e,n)=>this.css(t,e,n),dom_event:(t,e,n)=>this.event(t,e,n)}}getElement(t){return this.registry.get(t)}title(t){return document.title=t,"unknown"}create(t){return this.registry.add(document.createElement(t))}find(t){const e=document.querySelector(t);return e?this.registry.add(e):"unknown"}append(t,e){return this.getElement(t)?.appendChild(this.getElement(e)??document.createTextNode(e)),"unknown"}remove(t){return this.getElement(t).remove(),"unknown"}addClass(t,e){const n=this.getElement(t);return n instanceof HTMLElement&&n.classList.add(e),"unknown"}removeClass(t,e){const n=this.getElement(t);return n instanceof HTMLElement&&n.classList.remove(e),"unknown"}toggleClass(t,e){const n=this.getElement(t);return n instanceof HTMLElement&&n.classList.toggle(e),"unknown"}setText(t,e){const n=this.getElement(t);return n instanceof HTMLElement&&(n.innerText=e),"unknown"}setHtml(t,e){const n=this.getElement(t);return n instanceof HTMLElement&&(n.innerHTML=e),"unknown"}setAttr(t,e,n){return e.startsWith("on")?this.event(t,e.slice(2),n):this.getElement(t)?.setAttribute(e,n),"unknown"}getAttr(t,e){return this.getElement(t)?.getAttribute(e)}css(t,e,n){const s=this.getElement(t);return s instanceof HTMLElement&&s.style.setProperty(e,n),"unknown"}event(t,e,n){const r=this.getElement(t),i=this.runtime.getLib(s.a).getFn(n);return i&&r.addEventListener(e,(()=>i())),"unknown"}}var i=__webpack_require__(416);class o{constructor(){this.libs={}}addLib(t,e){return this.libs[t]=e}getLib(t){return Object.values(this.libs).find((e=>e instanceof t))}lib(t,n){this.addLib(t,new e.y(this,n))}scope(t){const e={variables:{},functions:{}};return t&&this.copyScope(t,e),e}copyScope(t,e){Object.assign(e.variables,t.variables),Object.assign(e.functions,t.functions)}lambda(t){return this.getLib(s.a).addFn(t)}print(t){void 0===(t=this.getLib(i.V).toJS(t))&&(t="unknown"),console.log(t)}}class a extends i.V{constructor(){super(...arguments),this.variables={js_env:"browser",js_window:this.registry.add(window),js_global:this.registry.add(globalThis)}}toJSObject(t){return t.startsWith("#dom:")?this.runtime.getLib(r).getElement(t):super.toJSObject(t)}}var c=__webpack_require__(642);class l extends e.j{constructor(){super(...arguments),this.functions={string_at:(t,e)=>t.at(Number.parseInt(e))??"unknown",string_length:t=>`${t.length}`,string_slice:(t,e,n)=>t.slice(Number.parseInt(e),Number.parseInt(n)),string_replace:(t,e,n)=>t.replaceAll(e,n),string_format:(t,...e)=>this.format(t,e)}}format(t,e){if(0===e.length)return t;let n="";const s=t.length;let r=0,i=0;for(;r<s;){const s=t[r];if(++r,"%"===s){if("%"!==t[r]){if(n+=e[i],++i,i>=e.length){n+=t.slice(r);break}continue}++r}n+=s}return n}}var h=__webpack_require__(126),u=__webpack_require__(842);function p(t){return(...e)=>{const n=t(...e.map((t=>Number.parseFloat(t))));return Number.isNaN(n)?"unknown":`${n}`}}class m extends e.j{constructor(){super(...arguments),this.variables={pi:`${Math.PI}`},this.functions={abs:p((t=>Math.abs(t))),sign:p((t=>Math.sign(t))),sqrt:p((t=>Math.sqrt(t))),mod:p(((t,e)=>t%e)),sin:p((t=>Math.sin(t))),cos:p((t=>Math.cos(t))),tan:p((t=>Math.tan(t))),asin:p((t=>Math.asin(t))),acos:p((t=>Math.acos(t))),atan:p(((t,e)=>null==e?Math.atan(t):Math.atan2(t,e))),sinh:p((t=>Math.sinh(t))),cosh:p((t=>Math.cosh(t))),tanh:p((t=>Math.tanh(t))),asinh:p((t=>Math.asinh(t))),acosh:p((t=>Math.acosh(t))),atanh:p((t=>Math.atanh(t))),exp:p((t=>Math.exp(t))),rad:p((t=>t*Math.PI/180)),deg:p((t=>180*t/Math.PI)),round:p(((t,e=1)=>Math.round(t/e)*e)),floor:p(((t,e=1)=>Math.floor(t/e)*e)),ceil:p(((t,e=1)=>Math.ceil(t/e)*e)),random:()=>`${Math.random()}`,randint:(t,e)=>this.randint(t,e)}}randint(t,e){const n=Number.parseFloat(t),s=Number.parseFloat(e),r=Math.min(n,s),i=Math.max(n,s);return`${Math.random()*(i-r)+r}`}}const d=new class extends o{constructor(){super(...arguments),this.groupRegistry=new n.O("ssxgroup")}scope(t){const e={variables:{},functions:{},components:{}};return t&&this.copyScope(t,e),e}copyScope(t,e){Object.assign(e.variables,t.variables),Object.assign(e.functions,t.functions),"components"in t&&"components"in e&&Object.assign(e.components,t.components)}ssx(t,e,n,s){const i=t.components[e];if(i)return i(n,s);{const t=this.getLib(r),i=t.create(e);for(const[e,s]of Object.entries(n))t.setAttr(i,e,s);if("unknown"!==s){const e=this.groupRegistry.get(s);if(e)for(const n of e)t.append(i,n);else t.append(i,s)}return i}}ssxGroup(...t){return this.groupRegistry.add(t)}};var f;d.addLib("dom",new r(d)),d.addLib("fn",new s.a(d)),d.addLib("js",new a(d)),d.addLib("ref",new c.t(d)),d.addLib("string",new l(d)),d.addLib("struct",new h.B(d)),d.addLib("array",new u.h(d)),d.addLib("math",new m(d)),function(t){t.isWhitespace=function(t){return" "===t||"\n"===t||"\r"===t},t.isDigit=function(t){if(!t)return!1;const e=t.charCodeAt(0);return e>=48&&e<=57},t.isLetter=function(t){if(!t)return!1;const e=t.toLowerCase().charCodeAt(0);return e>=97&&e<=122}}(f||(f={}));class _{constructor(t){this.buffer=t,this._offset=0,this.line=0,this.column=0}get location(){return{offset:this._offset,line:this.line,column:this.column}}set location(t){this._offset=t.offset,this.line=t.line,this.column=t.column}get offset(){return this._offset}peekch(){return this.buffer[this._offset]}consume(){"\n"===this.peekch()?(++this.line,this.column=0):++this.column,++this._offset}}class g{constructor(t={},e){this.elements=t,this.last=e}with(t,e){const n={...this.elements};return n[t]=n[t]?[...n[t],e]:[e],new g(n,e)}has(t,e){return this.elements[t]?.includes(e)}}class b{}class w extends b{constructor(t){super(),this.ch=t}match(t){const e=t.location;if(t.peekch()===this.ch)return t.consume(),{start:e,end:t.location}}}class x extends b{constructor(t,e){super(),this.a=t,this.b=e}match(t,e,n=1,s=new g,r={}){const i=t.location,o=!(this.a instanceof L&&s.has(i.offset,this.a.name))&&this.a.match(t,e,n,s,r),a=t.location;t.location=i;const c=!(this.b instanceof L&&s.has(i.offset,this.b.name))&&this.b.match(t,e,n,s,r),l=t.location;let h=!o&&c||!c&&o;if(o&&c&&(h=a.offset>l.offset?o:c),h===o&&(t.location=a),h)return{start:i,end:t.location,children:[h]}}}class y extends b{match(t){const e=t.location;for(;f.isWhitespace(t.peekch());)t.consume();return{start:e,end:t.location}}}class $ extends b{match(t){const e=t.location;if(t.peekch())return t.consume(),{start:e,end:t.location}}}class E extends b{match(t){const e=t.location;if(f.isDigit(t.peekch()))return t.consume(),{start:e,end:t.location}}}class v extends b{constructor(t){super(),this.pattern=t}match(t,e,n=1,s=new g,r={}){const i=t.location,o=this.pattern.match(t,e,n,s,r);return o||(t.location=i),{start:i,end:t.location,children:o?[o]:[]}}}class k extends b{constructor(t){super(),this.pattern=t}match(t,e,n=1,s=new g,r={}){const i=t.location;let o=this.pattern.match(t,e,n,s,r);const a=[o];if(!o)return;let c=t.location;for(;(o=this.pattern.match(t,e,n,s,r))&&c.offset!==t.offset;)a.push(o),c=t.location;return t.location=c,{start:i,end:t.location,children:a}}}class S extends b{constructor(t,e){super(),this.group=t,this.disallow=e}match(t){const e=t.location,n=t.peekch();if(!n)return;const s=n.charCodeAt(0);t.consume();for(const r of this.group)if(Array.isArray(r)&&s>=r[0].charCodeAt(0)&&s<=r[1].charCodeAt(0)||n===r)return!this.disallow&&{start:e,end:t.location};return this.disallow&&{start:e,end:t.location}}}class M extends b{constructor(t){super(),this.children=t}match(t,e,n=1,s=new g,r={}){const i=t.location,o=[];for(const i of this.children){const a=i.match(t,e,n,s,r);if(!a)return;o.push(a)}return{start:i,end:t.location,children:o}}}class L extends b{constructor(t,e){super(),this.name=t,this.unmatched=e}match(t,e,n=1,s=new g,r={}){const i=`${n},${s.last},${t.offset},${this.name}`,o=r[i];if(void 0!==o)return o&&(t.location=o.end),o;const a=t.location;s=s.with(a.offset,this.name);const c=e.get(this.name);if(!c||c.precedence&&c.precedence<n)return r[i]=null;const l=c.match(t,e,c.precedence||c.preservePrecedence?c.precedence??n:1,s,r);return this.unmatched?r[i]=l:r[i]=l?{name:this.name,start:a,end:t.location,children:[l]}:null}}function O(t){return"%"===t||"|"===t||"("===t||")"===t||"+"===t||"?"===t||"."===t}function j(t,e,n=!1){const s=[];let r,i=!1;for(;r=t.peekch();){if(t.consume(),"%"===r)if(r=t.peekch(),O(r))t.consume(),s.push(new w(r));else{let e=!1;"!"===t.peekch()&&(e=!0,t.consume());let n="";for(;f.isLetter(r=t.peekch());)t.consume(),n+=r;"d"===n?s.push(new E):s.push(new L(n,e))}else if("("===r)s.push(j(t,e));else{if(")"===r)break;if("["===r){const e="^"===t.peekch();e&&t.consume();const n=[];let i=!1;for(;r=t.peekch();){t.consume();const e=n.length;if("%"===r&&"]"===t.peekch())t.consume(),n.push("]");else{if("]"===r)break;if("-"===r&&!i&&e>0&&!Array.isArray(n.at(-1))){i=!0;continue}n.push(r)}if(i){i=!1;const t=n.pop();n.push([n.pop(),t])}}s.push(new S(n,e))}else if("."===r)s.push(new $);else if(" "===r)s.push(new y);else{if("|"===r&&s.length>0&&!i){i=!0;continue}"?"===r&&s.length>0?s.push(new v(s.pop())):"+"===r&&s.length>0?s.push(new k(s.pop())):s.push(new w(r))}}i&&(s.push(new x(s.pop(),s.pop())),i=!1)}const o=1===s.length?s[0]:new M(s);return o.precedence=e,o.preservePrecedence=n,o}function C(t,e,n){return j(new _(t),e,n)}class P{constructor(t,e,n,s){this.name=t,this.start=e,this.end=n,this.value=s,this.children=[]}get first(){return this.children[0]}get last(){return this.children.at(-1)}*[Symbol.iterator](){for(const t of this.children)yield t}addChild(t){this.children.push(t)}get(t){return this.children[t]}findChildren(t){return this.children.filter((e=>e.name===t))}findChild(t){return this.children.find((e=>e.name===t))}find(t){const e=this.findChild(t);if(e)return e;for(const e of this.children){const n=e.find(t);if(n)return n}}}class A{constructor(t){this.patterns=new Map,this.cache={};for(const[e,n]of Object.entries(t))"string"==typeof n?this.patterns.set(e,C(n)):this.patterns.set(e,C(n.pattern,n.precedence,n.preservePrecedence))}parse(t){const e=this.cache[t];if(void 0!==e)return e;const n=this.patterns.get("root").match(new _(t),this.patterns);if(!n)return;const s=new P("root",n.start,n.end,t.slice(n.start.offset,n.end.offset));return function e(n,s){if(n.name){const e=new P(n.name,n.start,n.end,t.slice(n.start.offset,n.end.offset));s.addChild(e),s=e}if(n.children)for(const t of n.children)e(t,s)}(n,s),s}}function q(t,e){return e.replace(/\.\.\./g,t)}function T(t,e){return t?e?"string"==typeof t&&"string"==typeof e?q(t,e):"string"==typeof t&&"string"!=typeof e?{...e,pattern:q(t,e.pattern)}:"string"!=typeof t&&"string"==typeof e?{...t,pattern:q(t.pattern,e)}:"string"!=typeof t&&"string"!=typeof e?{pattern:q(t.pattern,e.pattern),precedence:e.precedence??t.precedence,preservePrecedence:e.preservePrecedence??t.preservePrecedence}:void 0:t:e}const D={number:"%d+(%.%d+)?",name:"[a-zA-Z_][a-zA-Z0-9_]+?",string:'"([^"]|(\\\\)|(\\"))+?"',bool:"(true)|(false)",neg:"- %expr",add:{pattern:"%expr %+ %expr",precedence:5},sub:{pattern:"%expr - %expr",precedence:5},mul:{pattern:"%expr * %expr",precedence:6},div:{pattern:"%expr / %expr",precedence:6},concat:{pattern:"%expr @ %expr",precedence:1},eq:{pattern:"%expr = %expr",precedence:4},lt:{pattern:"%expr < %expr",precedence:4},gt:{pattern:"%expr > %expr",precedence:4},le:{pattern:"%expr <= %expr",precedence:4},ge:{pattern:"%expr >= %expr",precedence:4},or:{pattern:"%expr %| %expr",precedence:2},and:{pattern:"%expr & %expr",precedence:3},not:"! %expr",arglist:"(%expr( , %expr)+?)?",call:"%name %( %arglist %)",lambda:"%( %paramlist %) => ({ %body })|%expr",parenthesisexpr:"%( %expr %)",expr:{pattern:"%parenthesisexpr|%number|%string|%bool|%name|%neg|%add|%sub|%mul|%div|%concat|%eq|%lt|%gt|%le|%ge|%or|%and|%not|%call|%lambda",preservePrecedence:!0},assign:"%name = %expr;",paramlist:"(%name( , %name)+?)?",if:"if %expr { %body } %else?",else:"else { %body }",while:"while %expr { %body }",function:"fn %name %( %paramlist %) { %body }",return:"ret %expr;",callstat:"%call;",print:"print %expr;",statement:"%assign|%if|%while|%function|%return|%callstat|%print",comment:"//[^\n]+?",comments:"( %!comment )+?",body:"( %!comments %statement %!comments )+?",use:"use %name;",imports:"( %use %!comments )+?",lib:"lib %name;",root:"%!comments %lib? %!comments %imports %body %!comments"};class N{constructor(t,e={}){this.runtime=t,this.parser=new A(function(t,e){const n={root:T(t.root,e.root)};for(const s in t)s in n||(n[s]=T(t[s],e[s]));for(const s in e)s in n||(n[s]=T(t[s],e[s]));return n}(D,e))}compileExpr(t,e){switch("expr"===t.name&&(t=t.first),t.name){case"parenthesisexpr":return`(${this.compileExpr(t.first,e)})`;case"name":return`(scope${e}.variables.${t.value} ?? "unknown")`;case"number":case"bool":return`"${t.value}"`;case"string":return t.value;case"neg":return`\`\${-${this.compileExpr(t.first,e)}}\``;case"add":return`\`\${+${this.compileExpr(t.first,e)} + +${this.compileExpr(t.last,e)}}\``;case"sub":return`\`\${+${this.compileExpr(t.first,e)} - +${this.compileExpr(t.last,e)}}\``;case"mul":return`\`\${+${this.compileExpr(t.first,e)} * +${this.compileExpr(t.last,e)}}\``;case"div":return`\`\${+${this.compileExpr(t.first,e)} / +${this.compileExpr(t.last,e)}}\``;case"eq":return`\`\${${this.compileExpr(t.first,e)} === ${this.compileExpr(t.last,e)}}\``;case"lt":return`\`\${+${this.compileExpr(t.first,e)} < +${this.compileExpr(t.last,e)}}\``;case"gt":return`\`\${+${this.compileExpr(t.first,e)} > +${this.compileExpr(t.last,e)}}\``;case"le":return`\`\${+${this.compileExpr(t.first,e)} <= +${this.compileExpr(t.last,e)}}\``;case"ge":return`\`\${+${this.compileExpr(t.first,e)} >= +${this.compileExpr(t.last,e)}}\``;case"or":return`\`\${${this.compileExpr(t.first,e)} === "true" || ${this.compileExpr(t.last,e)} === "true"}\``;case"and":return`\`\${${this.compileExpr(t.first,e)} === "true" && ${this.compileExpr(t.last,e)} === "true"}\``;case"not":return`\`\${${this.compileExpr(t.first,e)} === "true" ? "false" : "true"}\``;case"concat":return`${this.compileExpr(t.first,e)} + ${this.compileExpr(t.last,e)}`;case"call":return`(${this.compileCall(t,e)} ?? "unknown")`;case"lambda":return`runtime.lambda(${t.findChild("expr")?this.compileLambda(t,e):this.compileFunction(t,e)})`}}compileCall(t,e){return`scope${e}.functions.${t.find("name").value}?.(${Array.from(t.find("arglist")).map((t=>this.compileExpr(t,e))).join(", ")})`}compileFunction(t,e){const n=Array.from(t.find("paramlist"));return`(${n.map(((t,e)=>`arg${e}="unknown"`)).join(", ")}) => {\n${this.localScope(++e)+n.map(((t,n)=>`scope${e}.variables.${t.value} = arg${n};\n`)).join("")+this.compileBody(t.find("body"),e)}return "unknown";\n}`}compileLambda(t,e){const n=Array.from(t.find("paramlist"));return`(${n.map(((t,e)=>`arg${e}="unknown"`)).join(", ")}) => {\n${this.localScope(++e)+n.map(((t,n)=>`scope${e}.variables.${t.value} = arg${n};\n`)).join("")}return ${this.compileExpr(t.find("expr"),e)};\n}`}compileStatement(t,e){switch(t.name){case"assign":return`scope${e}.variables.${t.find("name").value} = ${this.compileExpr(t.find("expr"),e)};`;case"if":{let n=`if ((${this.compileExpr(t.find("expr"),e)}) === "true") {\n${this.compileBody(t.find("body"),e)}}`;const s=t.findChild("else");return s&&(n+=`\nelse {\n${this.compileBody(s.find("body"),e)}}`),n}case"while":return`while ((${this.compileExpr(t.find("expr"),e)}) === "true") {\n${this.compileBody(t.find("body"),e)}}`;case"function":return`scope${e}.functions.${t.find("name").value} = ${this.compileFunction(t,e)};`;case"print":return`runtime.print(${this.compileExpr(t.find("expr"),e)});`;case"callstat":return this.compileCall(t.first,e)+";";case"return":return`return ${this.compileExpr(t.find("expr"),e)};`}}compileBody(t,e=0){let n="";for(const{first:s}of t)n+=this.compileStatement(s,e)+"\n";return n}localScope(t){return`const scope${t} = runtime.scope(scope${t-1});\n`}globalScope(){return"const scope0 = runtime.scope();\n"}compileImports(t){let e="";for(const n of t)e+=`runtime.libs.${n.find("name").value}?.use(scope0);\n`;return e}compileProgram(t){let e=this.globalScope();return e+=this.compileImports(t.find("imports")),e+=this.compileBody(t.find("body")),e+="return scope0;\n",e}createFunction(t){return Function("runtime",this.compileProgram(t))}getLibName(t){return this.parser.parse(t)?.findChild("lib")?.find("name")?.value}compile(t){const e=this.parser.parse(t);if(e&&e.end.offset===t.length)return this.compileProgram(e)}load(t){const n=this.parser.parse(t);if(!n||n.end.offset!==t.length)return;const s=n.findChild("lib"),r=this.createFunction(n);if(!s)return r(this.runtime);this.runtime.addLib(s.find("name").value,new e.y(this.runtime,r))}}const B={htmlname:"[a-z0-9-]+",htmlattrval:"%string|({ %expr })",htmlattr:"%htmlname=%htmlattrval",htmlentity:"&%htmlname;",htmltext:"([^&<>{}])+",htmlcontent:"(%htmltext|%htmlentity|({ %expr })|%html)+?",htmlsingle:"<%htmlname( %htmlattr )+? />",htmlpaired:"<%htmlname( %htmlattr )+?>%htmlcontent</%htmlname>",html:"%htmlsingle|%htmlpaired",expr:"...|%html",component:"fn <%htmlname( %htmlattr )+?> { %body }",statement:"...|%component"},I={amp:"&",lt:"<",gt:">"};globalThis.NativeLib=e.j,globalThis.sigmaScript=new class extends N{constructor(t){super(t,B)}compileHTMLContent(t,e){const n=[];for(const s of t)switch(s.name){case"htmltext":n.push(JSON.stringify(s.value));break;case"htmlentity":n.push(`"${I[s.find("htmlname").value]??s.value}"`);break;case"expr":case"html":n.push(this.compileExpr(s,e))}switch(n.length){case 0:return'"unknown"';case 1:return n[0];default:return`runtime.ssxGroup(${n.join(", ")})`}}compileExpr(t,e){if("expr"===t.name&&(t=t.first),"html"===t.name){const n="htmlpaired"===(t=t.first).name,s=t.first.value;return n&&t.last.value!==s?'"unknown"':`runtime.ssx(scope${e}, "${s}", { ${t.findChildren("htmlattr").map((t=>`"${t.find("htmlname").value}": ${this.compileExpr(t.find("htmlattrval").first,e)}`)).join(", ")} }, ${this.compileHTMLContent(t.findChild("htmlcontent"),e)})`}return super.compileExpr(t,e)}compileStatement(t,e){if("component"===t.name){const n={};for(const s of t.findChildren("htmlattr"))n[s.find("htmlname").value]=this.compileExpr(s.find("htmlattrval").first,e);return`scope${e}.components["${t.find("htmlname").value}"] = (attrs, children) => {\n${this.localScope(++e)}scope${e}.variables.children = children;\n${Object.keys(n).map((t=>`scope${e}.variables.${t} = attrs.${t} ?? ${n[t]};\n`)).join("")+this.compileBody(t.find("body"),e)}return "unknown";\n};`}return super.compileStatement(t,e)}}(d),new class{constructor(t,e){this.queue=[],this.type=t,this.load=e}loadScript(e){e.getAttribute("type")===this.type&&new t(this.queue,(async()=>{if(e.hasAttribute("src")){const t=await fetch(e.getAttribute("src"));return await t.text()}return e.innerText})(),(t=>this.load(t)))}listen(){new MutationObserver((t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)t instanceof HTMLScriptElement&&this.loadScript(t)})).observe(document,{childList:!0,subtree:!0});for(const t of document.getElementsByTagName("script"))this.loadScript(t)}}("text/sigmascript",(t=>globalThis.sigmaScript.load(t))).listen()})()})();